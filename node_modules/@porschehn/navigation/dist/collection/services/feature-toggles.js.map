{"version":3,"file":"feature-toggles.js","sourceRoot":"","sources":["../../../src/services/feature-toggles.ts"],"names":[],"mappings":"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","sourcesContent":["import { Environment, Environments, getEnvironment } from '../entities/environment';\nimport featureJson from '../feature-toggles.json';\nimport {\n  DEFAULT_ENVIRONMENT,\n  FEATURE_AB_TESTING,\n  FEATURE_DEALER_SEARCH_CHINA,\n  FEATURE_DEALER_SEARCH_OPENING_HOURS,\n  FEATURE_OVERRIDE_ENABLED,\n  FEATURE_PCOM_SEARCH,\n  FEATURE_SAVED_ITEMS,\n  FEATURE_SENTRY,\n  FEATURE_SHOP,\n  FEATURE_SHOP_WISHLIST\n} from '../utility/constants';\nimport { getConfig, isString } from '../utility/helper';\nimport { NaviError, NaviErrorTypes } from '../utility/navi-error';\nimport logger from './logger';\nimport windowService from './window-service';\n\ntype FeatureMap = { [featureName: string]: { enabled: boolean } };\n\nexport class FeatureToggles {\n  features: FeatureMap = {};\n  env: Environment = 'local';\n\n  constructor(\n    env = getEnvironment(DEFAULT_ENVIRONMENT),\n    private readonly featureEnvMap: { [env: string]: FeatureMap } = featureJson\n  ) {\n    this.env = env;\n    this.features = this.featureEnvMap[env];\n  }\n\n  private async loadRemoteToggles(): Promise<void> {\n    try {\n      const BFFEndpoint = getConfig(this.env).BFF_ENDPOINT;\n\n      const response = await fetch(`${BFFEndpoint}/toggles?env=${this.env}`);\n\n      if (!response.ok) {\n        const text = await response.text();\n        throw new Error(text);\n      }\n\n      const result = await response.json();\n\n      this.features = result;\n    } catch (err) {\n      throw new NaviError(`Load Feature Toggles failed with error: ${err}`, NaviErrorTypes.GENERAL);\n    }\n  }\n\n  private stringToBooleanStrict(value: string): boolean | null {\n    if (value === 'true') {\n      return true;\n    }\n    if (value === 'false') {\n      return false;\n    }\n    return null;\n  }\n\n  private getUrlFeatureToggleOverride(feature: string, searchString: string): boolean | null {\n    const queryValue = searchString\n      .split('?')[1]\n      ?.split('&')\n      .find((query) => query.includes(feature))\n      ?.split('=')[1];\n\n    return isString(queryValue) ? this.stringToBooleanStrict(queryValue || '') : null;\n  }\n\n  private getLocalStorageFeatureToggleOverride(feature: string): boolean | null {\n    const localStorageValue = localStorage.getItem(`phn.${feature}`);\n\n    return isString(localStorageValue) ? this.stringToBooleanStrict(localStorageValue) : null;\n  }\n\n  isFeatureEnabled(feature: string, searchString: string): boolean {\n    if (this.features === undefined) {\n      return false;\n    }\n\n    if (this.env === Environments.PRODUCTION && this.isOnSecurityLayer(feature)) {\n      return false;\n    }\n\n    if (this.features[FEATURE_OVERRIDE_ENABLED]?.enabled) {\n      const featureToggleOverrides = [\n        this.getUrlFeatureToggleOverride(feature, searchString),\n        this.getLocalStorageFeatureToggleOverride(feature)\n      ];\n\n      for (const featureToggleOverride of featureToggleOverrides) {\n        if (featureToggleOverride !== null) {\n          return featureToggleOverride;\n        }\n      }\n    }\n\n    if (this.features[feature] !== undefined) {\n      return this.features[feature].enabled;\n    } else {\n      return false;\n    }\n  }\n\n  async setFeatures(env: Environment): Promise<void> {\n    this.env = env;\n    try {\n      if (env === 'test') {\n        this.features = this.featureEnvMap[env];\n        return;\n      }\n      await this.loadRemoteToggles();\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    } catch (error: any) {\n      logger.error('INIT_APP_CONFIG', error);\n      this.features = this.featureEnvMap[env];\n    }\n  }\n\n  isOnSecurityLayer(feature: string): boolean {\n    const prodDisabledToggles = [FEATURE_SENTRY, FEATURE_DEALER_SEARCH_OPENING_HOURS];\n    return prodDisabledToggles.includes(feature);\n  }\n\n  isShopToggleActive = (): boolean => this.isFeatureEnabled(FEATURE_SHOP, windowService.location.search);\n  isPcomSearchToggleActive = (): boolean => this.isFeatureEnabled(FEATURE_PCOM_SEARCH, windowService.location.search);\n  isSavedItemsToggleActive = (): boolean => this.isFeatureEnabled(FEATURE_SAVED_ITEMS, windowService.location.search);\n  isABTestingToggleActive = (): boolean => this.isFeatureEnabled(FEATURE_AB_TESTING, windowService.location.search);\n  isDealerSearchChinaEnabled = (): boolean =>\n    this.isFeatureEnabled(FEATURE_DEALER_SEARCH_CHINA, windowService.location.search);\n  isDealerSearchOpeningHoursEnabled = (): boolean =>\n    this.isFeatureEnabled(FEATURE_DEALER_SEARCH_OPENING_HOURS, windowService.location.search);\n  isSentryEnabled = (): boolean => this.isFeatureEnabled(FEATURE_SENTRY, windowService.location.search);\n  isShopWishlistToggleActive = (): boolean =>\n    this.isFeatureEnabled(FEATURE_SHOP_WISHLIST, windowService.location.search);\n}\n\nexport default new FeatureToggles();\n"]}