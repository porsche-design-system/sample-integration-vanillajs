{"version":3,"names":["contentCache","Map","async","fetchContent","locale","app","config","getConfig","featureToggles","env","isShopEnabled","isShopToggleActive","Application","shop","naviContentPromise","fetchNaviContent","CONTENT_URL","shopContentPromise","fetchShopContent","SHOP_CONTENT_URL","Promise","resolve","naviContentResult","shopContentResult","allSettled","status","reason","naviContent","modifyShopItemDependingOnMarket","value","shopContent","Object","assign","children","menuItems","_a","additionalContent","availableLocales","availableLocalesOnlyForShop","contentUrl","country","language","splitLocale","cacheKey","constructCacheKey","cachedContent","get","undefined","data","fetch","headers","NaviError","NaviErrorTypes","NO_RESULTS","ok","GENERAL","content","json","set","toLowerCase","constructFlagURL","footerAssetsUrl","flag","includes","isCountryInOneOfRegions","split","getFlagURL","flagURL","res","err"],"sources":["src/services/content-service.ts"],"sourcesContent":["import { Content, ShopContentResponse } from '../entities/content';\nimport { isCountryInOneOfRegions, splitLocale } from '../entities/locale';\nimport { Application, ApplicationType } from '../utility/constants/app';\nimport { constructCacheKey, getConfig } from '../utility/helper';\nimport { modifyShopItemDependingOnMarket } from '../utility/helpers/shop-helper';\nimport { NaviError, NaviErrorTypes } from '../utility/navi-error';\nimport featureToggles from './feature-toggles';\n\nexport const contentCache = new Map<string, Content>();\n\nexport async function fetchContent(locale: string, app?: ApplicationType): Promise<Content> {\n  const config = getConfig(featureToggles.env);\n\n  const isShopEnabled = featureToggles.isShopToggleActive() && app === Application.shop;\n\n  const naviContentPromise = fetchNaviContent(config.CONTENT_URL, locale);\n  const shopContentPromise = isShopEnabled ? fetchShopContent(config.SHOP_CONTENT_URL, locale) : Promise.resolve(null);\n\n  const [naviContentResult, shopContentResult] = await Promise.allSettled([naviContentPromise, shopContentPromise]);\n\n  if (naviContentResult.status === 'rejected') {\n    throw naviContentResult.reason;\n  }\n\n  const naviContent = modifyShopItemDependingOnMarket(locale, app, naviContentResult.value);\n\n  const shopContent = shopContentResult.status === 'fulfilled' ? shopContentResult.value : null;\n\n  if (shopContent === null || naviContent.shop === null) {\n    return naviContent;\n  }\n\n  return {\n    ...naviContent,\n    shop: {\n      ...naviContent.shop,\n      children: shopContent.menuItems || naviContent.shop?.children || [],\n      additionalContent: shopContent.additionalContent,\n      availableLocales: naviContent.shop.availableLocales,\n      availableLocalesOnlyForShop: naviContent.shop.availableLocalesOnlyForShop\n    }\n  };\n}\n\nasync function fetchNaviContent(contentUrl: string, locale: string): Promise<Content> {\n  const { country, language } = splitLocale(locale);\n\n  const cacheKey = constructCacheKey(contentUrl, locale);\n\n  const cachedContent = contentCache.get(cacheKey);\n  if (cachedContent !== undefined) {\n    return cachedContent;\n  }\n\n  const data = await fetch(`${contentUrl}/${`${language}-${country}`}.json`, {\n    headers: {\n      'Cache-Control': 'no-cache',\n      'Content-Type': 'application/json'\n    }\n  });\n\n  if (data.status === 404) {\n    throw new NaviError(`No content for locale ${locale} found`, NaviErrorTypes.NO_RESULTS);\n  }\n\n  if (!data.ok) {\n    throw new NaviError(`Could not get content for locale ${locale}`, NaviErrorTypes.GENERAL);\n  }\n\n  const content = await data.json();\n\n  contentCache.set(cacheKey, content);\n\n  return content;\n}\n\nasync function fetchShopContent(contentUrl: string, locale: string): Promise<ShopContentResponse> {\n  const { country, language } = splitLocale(locale);\n\n  const data = await fetch(`${contentUrl}/${country.toLowerCase()}/${`${language}-${country}`}/navigation`, {\n    headers: {\n      'Content-Type': 'application/json',\n      'x-vercel-protection-bypass': 'SHOP_CONTENT_KEY'\n    }\n  });\n\n  if (data.status === 404) {\n    throw new NaviError(`No shop content for locale ${locale} found`, NaviErrorTypes.NO_RESULTS);\n  }\n\n  if (!data.ok) {\n    throw new NaviError(`Could not get shop content for locale ${locale}`, NaviErrorTypes.GENERAL);\n  }\n\n  return data.json();\n}\n\nexport function constructFlagURL(footerAssetsUrl: string, locale: string): string {\n  const { country } = splitLocale(locale);\n\n  let flag = country;\n  if (flag.includes('-') && !isCountryInOneOfRegions(flag)) {\n    flag = country.split('-')[0];\n  }\n\n  return `${footerAssetsUrl}/flags/${flag}.svg`;\n}\n\nexport async function getFlagURL(footerAssetsUrl: string, locale: string): Promise<string> {\n  try {\n    const flagURL = constructFlagURL(footerAssetsUrl, locale);\n\n    const res = await fetch(flagURL);\n\n    // Only set flagURL if flag actually exists\n    if (res.ok) {\n      return flagURL;\n    }\n  } catch (err) {\n    // ignore error\n  }\n\n  return '';\n}\n"],"mappings":"mLAQO,MAAMA,EAAe,IAAIC,IAEzBC,eAAeC,EAAaC,EAAgBC,G,MACjD,MAAMC,EAASC,EAAUC,EAAeC,KAExC,MAAMC,EAAgBF,EAAeG,sBAAwBN,IAAQO,EAAYC,KAEjF,MAAMC,EAAqBC,EAAiBT,EAAOU,YAAaZ,GAChE,MAAMa,EAAqBP,EAAgBQ,EAAiBZ,EAAOa,iBAAkBf,GAAUgB,QAAQC,QAAQ,MAE/G,MAAOC,EAAmBC,SAA2BH,QAAQI,WAAW,CAACV,EAAoBG,IAE7F,GAAIK,EAAkBG,SAAW,WAAY,CAC3C,MAAMH,EAAkBI,M,CAG1B,MAAMC,EAAcC,EAAgCxB,EAAQC,EAAKiB,EAAkBO,OAEnF,MAAMC,EAAcP,EAAkBE,SAAW,YAAcF,EAAkBM,MAAQ,KAEzF,GAAIC,IAAgB,MAAQH,EAAYd,OAAS,KAAM,CACrD,OAAOc,C,CAGT,OAAAI,OAAAC,OAAAD,OAAAC,OAAA,GACKL,GAAW,CACdd,KAAIkB,OAAAC,OAAAD,OAAAC,OAAA,GACCL,EAAYd,MAAI,CACnBoB,SAAUH,EAAYI,aAAaC,EAAAR,EAAYd,QAAI,MAAAsB,SAAA,SAAAA,EAAEF,WAAY,GACjEG,kBAAmBN,EAAYM,kBAC/BC,iBAAkBV,EAAYd,KAAKwB,iBACnCC,4BAA6BX,EAAYd,KAAKyB,+BAGpD,CAEApC,eAAea,EAAiBwB,EAAoBnC,GAClD,MAAMoC,QAAEA,EAAOC,SAAEA,GAAaC,EAAYtC,GAE1C,MAAMuC,EAAWC,EAAkBL,EAAYnC,GAE/C,MAAMyC,EAAgB7C,EAAa8C,IAAIH,GACvC,GAAIE,IAAkBE,UAAW,CAC/B,OAAOF,C,CAGT,MAAMG,QAAaC,MAAM,GAAGV,KAAc,GAAGE,KAAYD,WAAkB,CACzEU,QAAS,CACP,gBAAiB,WACjB,eAAgB,sBAIpB,GAAIF,EAAKvB,SAAW,IAAK,CACvB,MAAM,IAAI0B,EAAU,yBAAyB/C,UAAgBgD,EAAeC,W,CAG9E,IAAKL,EAAKM,GAAI,CACZ,MAAM,IAAIH,EAAU,oCAAoC/C,IAAUgD,EAAeG,Q,CAGnF,MAAMC,QAAgBR,EAAKS,OAE3BzD,EAAa0D,IAAIf,EAAUa,GAE3B,OAAOA,CACT,CAEAtD,eAAegB,EAAiBqB,EAAoBnC,GAClD,MAAMoC,QAAEA,EAAOC,SAAEA,GAAaC,EAAYtC,GAE1C,MAAM4C,QAAaC,MAAM,GAAGV,KAAcC,EAAQmB,iBAAiB,GAAGlB,KAAYD,iBAAwB,CACxGU,QAAS,CACP,eAAgB,mBAChB,6BAA8B,sCAIlC,GAAIF,EAAKvB,SAAW,IAAK,CACvB,MAAM,IAAI0B,EAAU,8BAA8B/C,UAAgBgD,EAAeC,W,CAGnF,IAAKL,EAAKM,GAAI,CACZ,MAAM,IAAIH,EAAU,yCAAyC/C,IAAUgD,EAAeG,Q,CAGxF,OAAOP,EAAKS,MACd,C,SAEgBG,EAAiBC,EAAyBzD,GACxD,MAAMoC,QAAEA,GAAYE,EAAYtC,GAEhC,IAAI0D,EAAOtB,EACX,GAAIsB,EAAKC,SAAS,OAASC,EAAwBF,GAAO,CACxDA,EAAOtB,EAAQyB,MAAM,KAAK,E,CAG5B,MAAO,GAAGJ,WAAyBC,OACrC,CAEO5D,eAAegE,EAAWL,EAAyBzD,GACxD,IACE,MAAM+D,EAAUP,EAAiBC,EAAiBzD,GAElD,MAAMgE,QAAYnB,MAAMkB,GAGxB,GAAIC,EAAId,GAAI,CACV,OAAOa,C,EAET,MAAOE,G,CAIT,MAAO,EACT,Q"}